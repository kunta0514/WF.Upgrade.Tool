# 业务库说明
请把加入的内容说明放在里面！

建议业务中的内容相对独立，按文件夹存放，公用提炼部分可放于public中，应该不常见。

Model请自带

如：CheckRule 数据库检查规则  balabalabala

DbUp 数据库升级 balabalabala
CodeUp 程序升级


### 环境初始化 - Site设计
使用场景：

    1、一线人员，配置ERP、工作流相关的程序后，使用工具后，生成对应的推荐方案。

        - 向导第一步，配置好站点相关的设置 - new
        - 包括IIS站点，网站物理文件，数据库链接地址等重要基础信息 - new
        - 根据配置文件，判断出升级前的工作流版本，并给出推荐的升级方案选项、实施步骤说明 - new

    2、一线人员根据推荐的方案（35系列、30系列、25系列），去完成工具中推荐的步骤。

        - 25系列升级步骤说明（待补充）  - new
        - 30系列升级步骤说明（待补充）  - new
        - 35系列升级步骤说明（待补充）  - new

    3、一线人员在推荐方案中可以明确了解本次升级需要涉及到项目干系人、及线下操作指引。

        - 帮助文件包括FAQ - new






### CheckRule设计
使用场景：
     
    1、开发/测试/一线人员，在开始升级前，使用“升级前-检测”功能，扫描当前库中存在的数据库问题，并把所有问题修复。
        - 这些问题有详细定位，并有明确的指引，补充问题现象与规则。 - new
        - 使用者可以按照推荐的方法、数据判断自行修复数据问题。
        - 使用者可以点击修复功能自动修复。
        - 修复后支持回滚，还原到修复前的状态（修复后，修复前的需要备份）
        
    2、在已经执行了升级语句后，开发/测试/一线人员可以使用“升级后-检测”功能继续扫描数据库中的问题，并把所有问题修复。
        - 这些问题有详细定位，并有明确的指引，补充问题现象与规则。 - new
        - 使用者可以按照推荐的方法、数据判断自行修复数据问题。
        - 使用者可以点击修复功能自动修复。
        - 修复后支持回滚，还原到修复前的状态（修复后，修复前的需要备份）

    3、开发/测试/一线人员，使用“异常数据检测”功能扫描当前数据库中，工作流相关的异常数据
        - TODO：继续补充已知版本的预警规则，以及修复规则，主要对象暂定为老版本，305SP1升级前

    4、开发/测试/一线人员，在检查玩数据库后，需要把错误导到excel中，用于线下修复数据问题。

代码设计要点：

1、每个检查规则对应一个类，也可以按类型抽象，类描述决定规则的使用版本，使用方式等内容
````C#  描述
//适合哪些版本 TODO：这个地方需要考虑标签型设计，考虑如何标签查询效率最大化
[FromVersion("251~305，305SP1")]
//目标版本，TODO：这个地方需要考虑标签型设计，考虑如何标签查询效率最大化
[ToVersion("352，重构")]     
//检查分类:before-up:升级前检查  after-up：升级后检查  all：任何时候检查   
[CheckRuleType("before-up")]   
//规则描述与说明     
[CheckRuleRemark("检索有非标准(包括放弃的)的责任人定义，请与一线确认是否需要保留")]
//检查种类:数据库检查、文件检查、JS检查等，类别需要细化
[CheckRuleKind("数据检测")]
//检查名称:规则的主键
[CheckRuleName("非标准产品的责任人解析规则")]

以上描述为保存到本地库中，且有对应字段保存
````

2、统一的接口输出格式，直接返回json字符串，UI部分自行解析
````json
{
    "name": "非标准产品的责任人解析规则",
    "err_code": "10010",
    "err_msg": "存在非标准的责任人定义",
    "check_count": "50",
    "extend":{param:""},
    "ex_list": [
    {
      "rule_name":"非标准产品的责任人解析规则",
      "table":"myWorkflowAuditorDefine",
      "pk":"AuditorScope",
      "pk_value":"2AC1EAFB-E169-4272-A9AB-0385F293560C",
      "ex_msg": "非标准的责任人定义:[上级部门主管]",
      "repair_param": {AuditorScope:"",AuditorName:""},//这个格式可以改，直接用key-value写，毕竟匿名json
      "extend": "继续扩展打开的地址，C#中的魔法方法怎么写？方法名是变量，直接指向方法"
    },
    {
      "rule_name":"非标准产品的责任人解析规则",
      "table":"myWorkflowAuditorDefine",
      "pk":"AuditorScope",
      "pk_value":"9AFED0E0-E4CE-4544-A621-0529424723D2",
      "ex_msg": "非标准的责任人定义:[上级部门主管]",
      "repair_param": {AuditorScope:"",AuditorName:""},
      "extend": "继续扩展打开的地址，C#中的魔法方法怎么写？方法名是变量，直接指向方法"
    },
    {
      "rule_name":"非标准产品的责任人解析规则",
      "table":"myWorkflowAuditorDefine",
      "pk":"AuditorScope",
      "pk_value":"DFC86A11-D935-4C0C-9D0E-06B3377D2DF9",
      "ex_msg": "非标准的责任人定义:[上级部门主管]",
      "repair_param": {AuditorScope:"",AuditorName:""},
      "extend": "继续扩展打开的地址，C#中的魔法方法怎么写？方法名是变量，直接指向方法"
    }
    ]
}
````

3、所需功能说明：

    升级前-检查：

        1.1 非标准产品的责任人解析规则

            - 继续明确出哪些在途流程使用了这些非标准关键字 - new

            - 检索有非标准(包括放弃的)的责任人定义，请与一线确认是否需要保留 - new

            - 模板中使用了未定义的责任人,需要通知一线调整，会导致流程无法发起。 - new

            - 现象：流程步骤中责任无法解析，责任人未明确，通知管理调整流程。 - new

        1.2 异常流程模版（缺少关键字段：业务对象、业务类型）、流程步骤定义（默认值）

            - 已启用的流程模版中没有所属系统（低版本可以读取Worklfow.config自动修复） - new

            - 已启用的流程模版中业务对象和业务类型不匹配。

            - 模版不方便一线去系统找（模版没查询功能），明确路径 - new

            - 检测流程模板分支条件是否正常 - new

            - 现象：导致流程无法发起、实例无法查看。 - new

        1.3 异常流程实例

            - 流程实例没有对应流程模板 - new

            - 现象：没有使用影响，但是需要查询界面兼容，未知模版的流程需要显示与查询 

            - 检测流程实例分支条件是否正常 - new

            - 现象：流程无法继续执行，提示找不到下一步。 
                
        1.4 在途流程中状态为[重新发起]的流程   

            - 需要按照版本区分，只有有校稿接口的才需要去点重新发起（301开始，或个性化老客户） - new

            - 现象：除当前责任人外，其他人无法看到后续步骤，或者没有归档步骤。 

        1.5 监控人字段异常

            - 监控人字段存在“;”开头，“，”结尾，UserGUID被截断的情况。
        
            - 现象：流程发起时黄页报错，显示GUID异常

    升级后-检查：

        1.1 异常流程模版（缺少关键字段：业务对象、业务类型）、流程步骤定义（默认值）

            - 已启用的流程模版中没有业务对象，请检查是否为通用审批流。 - new
            
            - 现象：可能会引起流程无法发起

            - 已启用的流程模版中业务对象和业务类型不匹配（有业务对象,没有业务类型；没有业务对象（包括业务对象被删除的情况）,有业务类型） - new

            - 现象：导致模板无法发起、实例无法查看
            
            - 模板中已经废弃的责任人

            - 流程模版中DomainXML存在异常（时间较长，会检查物理文件）
            
            - 现象：导致流程发起异常，流程无法归档。 

        1.2 异常流程实例

            - 流程在当前节点后，没有实例步骤 - new

            - 现象：流程实例所有除当前责任人以外，其他参与人查询，看不到后续步骤的流程

            - 流程实例没有对应业务类型

            - 现象：会引起分类中出现其他选项 - new

            - 流程实例没有对应流程模板

            - 现象：会引起分类中出现其他选项 - new

            - 流程实例业务类型为空

            - 现象：会引起分类中出现其他选项 - new

            - 流程实例没有对应SiteName

            - 现象：打开审批页面报错 - new

        1.3 流程代办等标签页的流程分类总数和列表数量不一致

            - 现象：显示不一致，查询有误 - new

        1.4 有序GUID约束缺失  - new
            
            - 现象：流程发起后报错，GUID字段确实。
        
        1.5 归档与作废的历史表单报错    - new

        1.6 当前步骤处于重新发起，且后续打回生成的步骤的IsCreatedByRollBack=0 - new

            - 现象：打回不重走的步骤，点重新发起后，变成了重走全部流程

        1.7 升级后，部分流程没有后续步骤，只有当前责任人可以看到后续步骤 - new

            - 现象：查询流程，除当前责任人以外，看不到后续步骤的流程

    通用-检查：
        1.1 表单修改业务数据链接扫描
         
        1.2 HTML表单自定义JS扫描，建议作为警告项提示   - new         
            - 现象：js中的pageload如果存在异常，那么会导致表单加载不出来。

        1.3 流程实例没有对应流程模板
            - 现象：会引起分类中出现其他选项。

        1.4 

    检查结果导出：
        1、每个检查规则中的详情界面可以导出到excel    - new

        2、全部检查结果可以导出到excel  - new

### DbUp设计

使用场景：

    1、开发/测试/一线人员，在检查完升级前的数据库，使用“数据库升级”的功能得到与自己数据库版本对应的升级sql脚本（结构升级、数据升级2部分）
    2、开发/测试/一线人员，可以选择由自己执行升级脚本，或者由工具执行，工具执行需要反馈出执行的问题。
    3、开发/测试/一线人员，在执行脚本前，需要有工具自动进行快照备份，并且可以在工具中随时点击还原功能，把数据库还原到执行前的状态。（建议生成脚本后就自动进行快照备份）



### 文件扫描设计

使用场景：

    1、开发/项目开发人员，在升级过程中检查ERP环境中，哪些使用到工作流内容的文件，是需要修改，根据问题级别确认是否需要调整。
    2、测试/一线人员，根据影响清单完成结果与修改前的建议，检查相关影响点修改是否正确。
    3、