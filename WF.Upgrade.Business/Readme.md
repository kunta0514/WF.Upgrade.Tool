# 业务库说明
请把加入的内容说明放在里面！

建议业务中的内容相对独立，按文件夹存放，公用提炼部分可放于public中，应该不常见。

Model请自带

如：CheckRule 数据库检查规则  balabalabala

DbUp 数据库升级 balabalabala
CodeUp 程序升级




### CheckRule设计
使用场景：
     
    1、开发/测试/一线人员，在开始升级前，使用“升级前-检测”功能，扫描当前库中存在的数据库问题，并把所有问题修复。
        - 这些问题有详细定位，并有明确的指引。
        - 使用者可以按照推荐的方法、数据判断自行修复数据问题。
        - 使用者可以点击修复功能自动修复。（修复后，修复前的需要备份）
        
    2、在已经执行了升级语句后，开发/测试/一线人员可以使用“升级后-检测”功能继续扫描数据库中的问题，并把所有问题修复。
        - 这些问题有详细定位，并有明确的指引。
        - 使用者可以按照推荐的方法、数据判断自行修复数据问题。
        - 使用者可以点击修复功能自动修复。（修复后，修复前的需要备份）

    3、开发/测试/一线人员，使用“异常数据检测”功能扫描当前数据库中，工作流相关的异常数据
        - TODO：继续补充已知版本的预警规则，以及修复规则，主要对象暂定为老版本，305SP1升级前

    4、开发/测试/一线人员，在检查玩数据库后，需要把错误导到excel中，用于线下修复数据问题。

代码设计要点：

1、每个检查规则对应一个类，也可以按类型抽象，类描述决定规则的使用版本，使用方式等内容
````C#  描述
//适合哪些版本 TODO：这个地方需要考虑标签型设计，考虑如何标签查询效率最大化
[FromVersion("251~305，305SP1")]
//目标版本，TODO：这个地方需要考虑标签型设计，考虑如何标签查询效率最大化
[ToVersion("352，重构")]     
//检查分类:before-up:升级前检查  after-up：升级后检查  all：任何时候检查   
[CheckRuleType("before-up")]   
//规则描述与说明     
[CheckRuleRemark("检索有非标准(包括放弃的)的责任人定义，请与一线确认是否需要保留")]
//检查种类:数据库检查、文件检查、JS检查等，类别需要细化
[CheckRuleKind("数据检测")]
//检查名称:规则的主键
[CheckRuleName("非标准产品的责任人解析规则")]

以上描述为保存到本地库中，且有对应字段保存
````

2、统一的接口输出格式，直接返回json字符串，UI部分自行解析
````json
{
    "name": "非标准产品的责任人解析规则",
    "err_code": "10010",
    "err_msg": "存在非标准的责任人定义",
    "check_count": "50",
    "extend":{param:""},
    "ex_list": [
    {
      "rule_name":"非标准产品的责任人解析规则",
      "table":"myWorkflowAuditorDefine",
      "pk":"AuditorScope",
      "pk_value":"2AC1EAFB-E169-4272-A9AB-0385F293560C",
      "ex_msg": "非标准的责任人定义:[上级部门主管]",
      "repair_param": {AuditorScope:"",AuditorName:""},//这个格式可以改，直接用key-value写，毕竟匿名json
      "extend": "继续扩展打开的地址，C#中的魔法方法怎么写？方法名是变量，直接指向方法"
    },
    {
      "rule_name":"非标准产品的责任人解析规则",
      "table":"myWorkflowAuditorDefine",
      "pk":"AuditorScope",
      "pk_value":"9AFED0E0-E4CE-4544-A621-0529424723D2",
      "ex_msg": "非标准的责任人定义:[上级部门主管]",
      "repair_param": {AuditorScope:"",AuditorName:""},
      "extend": "继续扩展打开的地址，C#中的魔法方法怎么写？方法名是变量，直接指向方法"
    },
    {
      "rule_name":"非标准产品的责任人解析规则",
      "table":"myWorkflowAuditorDefine",
      "pk":"AuditorScope",
      "pk_value":"DFC86A11-D935-4C0C-9D0E-06B3377D2DF9",
      "ex_msg": "非标准的责任人定义:[上级部门主管]",
      "repair_param": {AuditorScope:"",AuditorName:""},
      "extend": "继续扩展打开的地址，C#中的魔法方法怎么写？方法名是变量，直接指向方法"
    }
    ]
}
````

3、所需功能说明：

    升级前-检查：
        1.1 非标准产品的责任人解析规则
            -继续明确出哪些在途流程使用了这些非标准关键字 - new
        1.2 异常流程模版（缺少关键字段：业务对象、业务类型）、流程步骤定义（默认值）
            -已启用的流程模版中没有所属系统
            -已启用的流程模版中业务对象和业务类型不匹配
            -模版不方便一线去系统找（模版没查询功能），明确路径 - new
        1.3 异常流程实例
            -流程实例没有对应流程模板，继续缩小范围在途实例 - new
        1.4 在途流程中状态为[重新发起]的流程   
            -需要按照版本区分，只有有校稿接口的才需要去点重新发起（301开始，或个性化老客户） - new

    升级后-检查：
        1.1 异常流程模版（缺少关键字段：业务对象、业务类型）、流程步骤定义（默认值）
            -已启用的流程模版中没有业务对象
            -已启用的流程模版中业务对象和业务类型不匹配
            -模板中已经废弃的责任人
            -流程模版中DomainXML存在异常（时间较长，会检查物理文件）
        1.2 异常流程实例
            -流程实例没有对应业务类型
            -流程实例没有对应流程模板
            -流程实例没有对应SiteName
            -流程实例业务类型为空
        1.3 流程代办等标签页的流程分类总数和列表数量不一致

    检查结果导出：
        1、每个检查规则中的详情界面可以导出到excel
        2、全部检查结果可以导出到excel

### DbUp设计

使用场景：

    1、开发/测试/一线人员，在检查完升级前的数据库，使用“数据库升级”的功能得到与自己数据库版本对应的升级sql脚本（结构升级、数据升级2部分）
    2、开发/测试/一线人员，可以选择由自己执行升级脚本，或者由工具执行，工具执行需要反馈出执行的问题。
    3、开发/测试/一线人员，在执行脚本前，需要有工具自动进行快照备份，并且可以在工具中随时点击还原功能，把数据库还原到执行前的状态。（建议生成脚本后就自动进行快照备份）

