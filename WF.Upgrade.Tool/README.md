# WF.Upgrade.Tool
## 工具基本结构
混合开发模式：WPF+WEB+Business业务核心库+Framework程序核心库

#### WPF
APP部分，负责所有与PC相关的接口功能，负责工具所需数据的读写。
使用sqllite进行本地数据存储。负责工具主页、内容导航、运行效果等平台级的功能。
（app:Command/Console/Event/Helper/Http/Job/Providers/Utility）

#### WEB
静态页面模式，目前版本不使用MVC独立web部署，主要负责UI交互、体验，数据读写全部来自WPF的接口（js对象注入特性）
前端依赖jqery、bootstrap、template等各种前端组件，保持所有插件支持bootstrap风格即可。


#### 业务核心库（Business）
业务/服务(Business/Service)组成，不依赖外部model，输出统一为json
接口部分配上返回格式说明即可，也可认为是匿名对象

#### 程序核心库（Framework）
包括Database，Log，Mail，Msg，Queue，cache，Auth等各类平台级的功能，可按需启用，
DB多实例模式，支持sqllite、sql、mysql等

TODO：目前核心库需要规整合并

#### 其他说明
model各层个按需自己创建及使用，但不要相互引用，对接模式都已json为准。


## 工具基本功能

### 一、数据检查功能（检查规则）

#### 1.检查异常数据
    升级前：
        1.1 非标准产品的责任人解析规则
        1.2 异常流程模版（缺少关键字段：业务对象、业务类型）、流程步骤定义（默认值）
            -已启用的流程模版中没有所属系统
            -已启用的流程模版中业务对象和业务类型不匹配
        1.3 异常流程实例
            -流程实例没有对应流程模板
        1.4 在途流程中状态为[重新发起]的流程        

    升级后：
        1.1 异常流程模版（缺少关键字段：业务对象、业务类型）、流程步骤定义（默认值）
            -已启用的流程模版中没有业务对象
            -已启用的流程模版中业务对象和业务类型不匹配
            -模板中已经废弃的责任人
            -流程模版中DomainXML存在异常
        1.2 异常流程实例
            -流程实例没有对应业务类型
            -流程实例没有对应流程模板
            -流程实例没有对应SiteName
            -流程实例业务类型为空
        1.3 流程代办等标签页的流程分类总数和列表数量不一致

    全部：
        1.1 表单修改业务数据链接扫描
        1.2 HTML表单自定义JS扫描

#### 2.表单检查
    2.1 表单扫描规则: 
        1.检测业务对象存在，对应物理文件是否存在
        2.流程模版表单的BT_DomainXML中存在字段，但是在业务对象中不存在（305SP1之前的系统），导致无法发起
        2.流程模版表单的BT_DomainXML中存在重复的字段，导致无法发起
        3.html表单检测
          3.1 检测html是否存在js(配置项)
          3.2 检测html对应的节点属性是否存在重复
          3.3 检测html中节点对应的BT_DomainXML是否存在
          3.4 检测html中节点对应属性是否正确(配置项)
          3.5 检测单列模式中列是否在BT_DomainXML是否存在
          3.6 html表单JavaScript代码中使用到bt_domainxml字段的模板
          3.7 html表单中字段重复的
        4.定制表单检测：
          4.1 检测对应文件是否存在
          4.2 检测对应文件中是否存在必须包含js文件
          4.3 检测单列模式中列是否在BT_DomainXML是否存在 
        5.pageload函数中有脚本错误，脚本中存在使用html控件的，getelementbyid("XXid")，扫描表单中是否存在XXid这个控件。不存在就会出问题
        6.移动表单显示名称是否包含input命名的      
        7.域重名：手机表单域重名，PC表单域重名，domainxml中的域重名

    2.2 修改业务数据链接（原来在步骤中配置，现在是在业务对象中设置，扫描出来告知一线）

    2.3 定制表单中出现老平台的用法（appForm），与新工作流写法不兼容。（清单持续累积）

    2.4 表单中包含自定义的JS（打印中带JS可能会导致打印异常）
    ……

#### 3.文件检查
    3.1、老系统业务对象文件扫描（参考domainxml的扫描规则，郭飞工具中有实现）
    3.2、老ERP直接调用工作流页面、对象的场景（表、字段累积补充）（305前）
    3.3、老ERP桌面部件打开方式。（）
    3.4、webconfig文件自动处理。
    ……

#### 4、IIS站点相关检查(技术方案待验证)
    4.1、upfiles的虚拟目录设置
    4.2、……
###### 流程归档后，按文档分类存放在指定的文档目录中，便于集中管理


#### 5、其他检查
    5.1、SSO检查
    5.2、签章导航栏检查    
    5.3、更新结果检查，检查工作流站点的代码文件是否正确更新到ERP、采招站点。

#### 6、异常结果，程序修复
     6.1 所有检查项的数据结果，能够关联到具体问题，由程序修复
     6.1 所有检查项的数据结果，能够关联到具体问题，由程序修复

### 二、升级功能
- - - 

#### 1、数据库升级。
        1.1、工具对比最新版工作流数据库，生成结构升级、数据升级2部分升级语句

        1.2、结构升级部分支持重复执行，支持还原。（新增字段的默认值需要补充）
        
        1.3、原库中的索引需要加入到待移植清单，供分析使用。
        
        1.4、支持251~303全系列数据升级到最新，老版中的差异使用版本管理。
        
        1.5、支持标准包SQL快速生成，即没有个性化的用户分析后直接生成对应SQL更新。

#### 2、工作流程序升级
        2.1、251~305全系列，生成工作流站点的全包，并生成其他站点的更新包（其他站点中的工作流客户端）
        
        2.2、305SP1后，独立站点版本的工作流，可以生成增量更新包
        
        2.3、插件更新与代码更新分离（控制包大小，方便一线接收）
#### 3、ERP、采招站点文件修改。
        3.1、根据不同ERP版本生成必须要修改的文件清单，帮助开发修改与检查。
        
        3.2、内嵌对比工具，文件对比时自动调整文件编码，防止出现修改后中文乱码。
        
        3.3、工具完成webconfig等配置文件的内容修改

#### 4、流程定义中的默认值。
        4.1、需要根据客户的使用情况生成默认值批量修改语句。（默认值清单化，勾选生成对应脚本）

#### 5、数据迁移功能。
        5.1、支持历史所有版本->630版本。（251前不考虑）

