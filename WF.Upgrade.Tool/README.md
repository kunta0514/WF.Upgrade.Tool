# WF.Upgrade.Tool
## 工具基本结构
混合开发模式：WPF+WEB+Business业务核心库+Framework程序核心库

其他第三方依赖库请用NUGET

#### WPF
APP部分，负责所有与PC相关的接口功能，
负责工具所需数据的读写，使用sqllite进行本地数据存储。
负责工具主页、内容导航、运行效果等平台级的功能。
（app:Command/Console/Event/Helper/Http/Job/Providers/Utility）

#### WEB
静态页面模式，目前版本不使用MVC独立web部署，主要负责UI交互、体验，数据读写全部来自WPF的接口（js对象注入特性）
前端依赖jqery、bootstrap、template等各种前端组件，保持所有插件支持bootstrap风格即可。
（11月份的版本再考虑切换到独立部署）

#### 业务核心库（Business）
业务/服务(Business/Service)组成，不依赖外部model，输出统一为json
接口部分配上返回格式说明即可，也可认为是匿名对象

#### 程序核心库（Framework）
包括Database，Log，Mail，Msg，Queue，cache，Auth等各类平台级的功能，可按需启用，
DB多实例模式，支持sqllite、sql、mysql等

TODO：目前核心库需要规整合并

#### 其他说明
model各层个按需自己创建及使用，但不要相互引用，对接模式都已json为准。


## 工具基本功能
功能说明，重点表述功能原则，并非详细程序/UI设计，高保真只能指导大原则，交互细节需要靠个人与团队完善。
体验第一原则，一切如果自己都用的不爽的功能，都要优化，接受组里至少2人的意见。

主页需要表现出明确的操作指引（表现出步骤与意图）

### 一、数据检查功能（检查规则）

### CheckRule设计
使用场景：
     
    1、开发/测试/一线人员，在开始升级前，使用“升级前-检测”功能，扫描当前库中存在的数据库问题，并把所有问题修复。
        - 这些问题有详细定位，并有明确的指引，补充问题现象与规则。 - new
        - 使用者可以按照推荐的方法、数据判断自行修复数据问题。
        - 使用者可以点击修复功能自动修复。
        - 修复后支持回滚，还原到修复前的状态（修复后，修复前的需要备份）
        
    2、在已经执行了升级语句后，开发/测试/一线人员可以使用“升级后-检测”功能继续扫描数据库中的问题，并把所有问题修复。
        - 这些问题有详细定位，并有明确的指引，补充问题现象与规则。 - new
        - 使用者可以按照推荐的方法、数据判断自行修复数据问题。
        - 使用者可以点击修复功能自动修复。
        - 修复后支持回滚，还原到修复前的状态（修复后，修复前的需要备份）

    3、开发/测试/一线人员，使用“异常数据检测”功能扫描当前数据库中，工作流相关的异常数据
        - TODO：继续补充已知版本的预警规则，以及修复规则，主要对象暂定为老版本，305SP1升级前

    4、开发/测试/一线人员，在检查玩数据库后，需要把错误导到excel中，用于线下修复数据问题。

代码设计要点：

1、每个检查规则对应一个类，也可以按类型抽象，类描述决定规则的使用版本，使用方式等内容
````C#  描述
//适合哪些版本 TODO：这个地方需要考虑标签型设计，考虑如何标签查询效率最大化
[FromVersion("251~305，305SP1")]
//目标版本，TODO：这个地方需要考虑标签型设计，考虑如何标签查询效率最大化
[ToVersion("352，重构")]     
//检查分类:before-up:升级前检查  after-up：升级后检查  all：任何时候检查   
[CheckRuleType("before-up")]   
//规则描述与说明     
[CheckRuleRemark("检索有非标准(包括放弃的)的责任人定义，请与一线确认是否需要保留")]
//检查种类:数据库检查、文件检查、JS检查等，类别需要细化
[CheckRuleKind("数据检测")]
//检查名称:规则的主键
[CheckRuleName("非标准产品的责任人解析规则")]

以上描述为保存到本地库中，且有对应字段保存
````

2、统一的接口输出格式，直接返回json字符串，UI部分自行解析
````json
{
    "name": "非标准产品的责任人解析规则",
    "err_code": "10010",
    "err_msg": "存在非标准的责任人定义",
    "check_count": "50",
    "extend":{param:""},
    "ex_list": [
    {
      "rule_name":"非标准产品的责任人解析规则",
      "table":"myWorkflowAuditorDefine",
      "pk":"AuditorScope",
      "pk_value":"2AC1EAFB-E169-4272-A9AB-0385F293560C",
      "ex_msg": "非标准的责任人定义:[上级部门主管]",
      "repair_param": {AuditorScope:"",AuditorName:""},//这个格式可以改，直接用key-value写，毕竟匿名json
      "extend": "继续扩展打开的地址，C#中的魔法方法怎么写？方法名是变量，直接指向方法"
    },
    {
      "rule_name":"非标准产品的责任人解析规则",
      "table":"myWorkflowAuditorDefine",
      "pk":"AuditorScope",
      "pk_value":"9AFED0E0-E4CE-4544-A621-0529424723D2",
      "ex_msg": "非标准的责任人定义:[上级部门主管]",
      "repair_param": {AuditorScope:"",AuditorName:""},
      "extend": "继续扩展打开的地址，C#中的魔法方法怎么写？方法名是变量，直接指向方法"
    },
    {
      "rule_name":"非标准产品的责任人解析规则",
      "table":"myWorkflowAuditorDefine",
      "pk":"AuditorScope",
      "pk_value":"DFC86A11-D935-4C0C-9D0E-06B3377D2DF9",
      "ex_msg": "非标准的责任人定义:[上级部门主管]",
      "repair_param": {AuditorScope:"",AuditorName:""},
      "extend": "继续扩展打开的地址，C#中的魔法方法怎么写？方法名是变量，直接指向方法"
    }
    ]
}
````

3、所需功能说明：

    升级前-检查：

        1.1 非标准产品的责任人解析规则

            - 继续明确出哪些在途流程使用了这些非标准关键字 - new

            - 检索有非标准(包括放弃的)的责任人定义，请与一线确认是否需要保留 - new

            - 模板中使用了未定义的责任人,需要通知一线调整，会导致流程无法发起。 - new

            - 现象：流程步骤中责任无法解析，责任人未明确，通知管理调整流程。 - new

        1.2 异常流程模版（缺少关键字段：业务对象、业务类型）、流程步骤定义（默认值）

            - 已启用的流程模版中没有所属系统（低版本可以读取Worklfow.config自动修复） - new

            - 已启用的流程模版中业务对象和业务类型不匹配。

            - 模版不方便一线去系统找（模版没查询功能），明确路径 - new

            - 检测流程模板分支条件是否正常 - new

            - 现象：导致流程无法发起、实例无法查看。 - new

        1.3 异常流程实例

            - 流程实例没有对应流程模板 - new

            - 现象：没有使用影响，但是需要查询界面兼容，未知模版的流程需要显示与查询 

            - 检测流程实例分支条件是否正常 - new

            - 现象：流程无法继续执行，提示找不到下一步。 
                
        1.4 在途流程中状态为[重新发起]的流程   

            - 需要按照版本区分，只有有校稿接口的才需要去点重新发起（301开始，或个性化老客户） - new

            - 现象：除当前责任人外，其他人无法看到后续步骤，或者没有归档步骤。 

        1.5 监控人字段异常

            - 监控人字段存在“;”开头，“，”结尾，UserGUID被截断的情况。
        
            - 现象：流程发起时黄页报错，显示GUID异常

    升级后-检查：

        1.1 异常流程模版（缺少关键字段：业务对象、业务类型）、流程步骤定义（默认值）

            - 已启用的流程模版中没有业务对象，请检查是否为通用审批流。 - new
            
            - 现象：可能会引起流程无法发起

            - 已启用的流程模版中业务对象和业务类型不匹配（有业务对象,没有业务类型；没有业务对象（包括业务对象被删除的情况）,有业务类型） - new

            - 现象：导致模板无法发起、实例无法查看
            
            - 模板中已经废弃的责任人

            - 流程模版中DomainXML存在异常（时间较长，会检查物理文件）
            
            - 现象：导致流程发起异常，流程无法归档。 

        1.2 异常流程实例

            - 流程在当前节点后，没有实例步骤 - new

            - 现象：流程实例所有除当前责任人以外，其他参与人查询，看不到后续步骤的流程

            - 流程实例没有对应业务类型

            - 现象：会引起分类中出现其他选项 - new

            - 流程实例没有对应流程模板

            - 现象：会引起分类中出现其他选项 - new

            - 流程实例业务类型为空

            - 现象：会引起分类中出现其他选项 - new

            - 流程实例没有对应SiteName

            - 现象：打开审批页面报错 - new

        1.3 流程代办等标签页的流程分类总数和列表数量不一致

            - 现象：显示不一致，查询有误 - new

        1.4 有序GUID约束缺失  - new
            
            - 现象：流程发起后报错，GUID字段确实。
        
        1.5 归档与作废的历史表单报错    - new

        1.6 当前步骤处于重新发起，且后续打回生成的步骤的IsCreatedByRollBack=0 - new

            - 现象：打回不重走的步骤，点重新发起后，变成了重走全部流程

        1.7 升级后，部分流程没有后续步骤，只有当前责任人可以看到后续步骤 - new

            - 现象：查询流程，除当前责任人以外，看不到后续步骤的流程

    通用-检查：

        1.1 表单修改业务数据链接扫描
         
        1.2 HTML表单自定义JS扫描，建议作为警告项提示   - new         
            - 现象：js中的pageload如果存在异常，那么会导致表单加载不出来。

        1.3 流程实例没有对应流程模板
            - 现象：会引起分类中出现其他选项。

    检查结果：

        1、详情界面需要有更准确的表述，帮助快速了解、查询问题细节    - new
            - 包括问题原因、现象、推荐的修复动作、测试建议等关键内容

        2、每个检查规则中的详情界面可以导出到excel    - new
            - 单个问题详情可以单独导出excel，供开发、一线分析数据问题使用

        3、全部检查结果可以导出到excel  - new
            - 检查后的结果，提供批量导出功能，供开发、一线记录不同阶段的数据修复情况
            - 此处可考虑工具记录，配合自动修复功能与备份功能。

    扫描过程：        
        1、带有文件检测的事项会导致程序会有假死现象，扫描时间长，考虑分批处理，优化体验，另外扫描中的效果需要补充，最好能针对到事项的进度控制。



圣哥、少东    
    

#### 2.表单检查
    2.1 表单扫描规则（需要继续补充规则）: 
        1.检测业务对象存在，对应物理文件是否存在
        2.流程模版表单的BT_DomainXML中存在字段，但是在业务对象中不存在（305SP1之前的系统），导致无法发起
        2.流程模版表单的BT_DomainXML中存在重复的字段，导致无法发起
        3.html表单检测
          3.1 检测html是否存在js(配置项)
          3.2 检测html对应的节点属性是否存在重复
          3.3 检测html中节点对应的BT_DomainXML是否存在
          3.4 检测html中节点对应属性是否正确(配置项)
          3.5 检测单列模式中列是否在BT_DomainXML是否存在
          3.6 html表单JavaScript代码中使用到bt_domainxml字段的模板
          3.7 html表单中字段重复的
        4.定制表单检测：
          4.1 检测对应文件是否存在
          4.2 检测对应文件中是否存在必须包含js文件
          4.3 检测单列模式中列是否在BT_DomainXML是否存在 
        5.pageload函数中有脚本错误，脚本中存在使用html控件的，getelementbyid("XXid")，扫描表单中是否存在XXid这个控件，不存在就会出问题。
        6.移动表单显示名称是否包含input命名的      
        7.域重名：手机表单域重名，PC表单域重名，domainxml中的域重名
    2.2 修改业务数据链接（原来在步骤中配置，现在是在业务对象中设置，扫描出来告知一线）
    2.3 定制表单中出现老平台的用法（appForm），与新工作流写法不兼容。（清单持续累积）
    2.4 表单中包含自定义的JS（打印中带JS可能会导致打印异常）
    ……

静静

#### 3.文件检查
    3.1、老系统业务对象文件扫描（参考domainxml的扫描规则，郭飞工具中有实现）
    3.2、老ERP直接调用工作流页面、对象的场景（表、字段累积补充）（305前）
    3.3、老ERP桌面部件打开方式。（）
    3.4、webconfig文件自动处理。
    ……
圣哥

#### 4、IIS站点相关检查(技术方案待验证)
    4.1、upfiles的虚拟目录设置
    4.2、……
老刘


#### 5、其他检查
    5.1、SSO检查
    5.2、签章导航栏检查    
    5.3、更新结果检查，检查工作流站点的代码文件是否正确更新到ERP、采招站点。

#### 6、异常结果，程序修复
     6.1 所有检查项的数据结果，能够关联到具体问题，由程序修复

### 二、升级功能
- - - 

#### 1、数据库升级。
    1.1、251~305为源数据库，630为目标数据库，按需选择升级路径。
        - 版本信息读取数据库及版本文件双向校验，也可以手选。  - new
        - 目标库630,可以只包含工作流相关数据对象。 - new
        - 目标库需要有保障机制，指向最稳定的数据库版本。 - new
    1.2、工具自动对比分析升级前后的数据库差异，数据对象脚本（表、字段及约束、视图、存储过程、函数）、数据升级语句（除了前面以外的所有部分）2部分升级语句，结构升级SQL支持重复执行。
        - 各个版本的数据对象升级内容清单需要明确。对象相关的脚本要求可重复执行 - new
        - 数据升级规则需要明确。现有规则+历史脚本分析，双向保障。 - new
        - 结构升级清单、数据升级规则都需要有明确版本标签，结构上要支持自由组合，如256版本要1，2，3规则，303只要1，2.这是根据版本组合而成的。
        - 表字段不要先删再加！会导致升级有问题，会把客户数据库原有的数据清掉！
        - 目前库中有很多垃圾数据对象没有清理，有黑名单的，有重名的，usp_myWorkflowGetStepAuditors，usp_WF_GetStepAuditors这2种
    1.3、各个历史版本与最新版的数据结构差异，需要清单化输出，便于后续进一步分析升级过程。        
    1.4、需要有快速还原功能，升级过程包含表备份，最终是快照还原，还是脚本还原根据使用情况决定，体验第一原则。
    1.5、原库中的索引需要加入到待移植清单，供分析使用。        
    1.6、支持251~305全系列数据升级到最新，标准版本升级语句需要内置到程序中。
    
        
老刘、少东

#### 2、工作流程序升级
        2.1、251~305全系列，支持一键生成更新包，630的程序内置到工具中。        
        2.2、已升级的可以继续分析，生成增量更新包。        
            - 目前升级的迭代更新包，打包效率极低，错误率也高。 - new
            - 新版本，更新ERP、工作流站点的文件规则不清晰。 - new
        2.3、插件更新与代码更新分离（控制包大小，方便一线接收）
        2.4、多站点webconfig文件的检查与更新
            - 一线经常出现的错误是在上线阶段反复操作测试站点与正式站点，用测试站点的配置文件覆盖正式站点。
少东

#### 3、ERP、采招站点文件修改。
        3.1、根据不同ERP版本生成必须要修改的文件清单，帮助开发修改与检查。（规则按客户复盘总结的提炼）        
        3.2、内嵌对比工具，文件对比时自动调整文件编码，防止出现修改后中文乱码。 （穷举各类型文件的打开方式 aspx,js,html,htc,vb,c#等代码文件）       
        3.3、工具完成webconfig等配置文件的内容修改
圣哥

#### 4、流程定义中的默认值。
        4.1、需要根据客户的使用情况生成默认值批量修改语句。（默认值清单化，勾选生成对应脚本）

圣哥
#### 5、数据迁移功能。
        5.1、支持历史所有版本->630版本。（251前不考虑）
老刘、少东


#### 6、工具自动更新


最后，请保障签入的代码是消灭了所有编译问题的，代码是可运行的，另外警告也请能修复就修复。
