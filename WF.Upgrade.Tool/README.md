# WF.Upgrade.Tool
## 工具基本结构
混合开发模式：WPF+WEB+Business业务核心库+Framework程序核心库

#### WPF
APP部分，负责所有与PC相关的接口功能，
负责工具所需数据的读写，使用sqllite进行本地数据存储。
负责工具主页、内容导航、运行效果等平台级的功能。
（app:Command/Console/Event/Helper/Http/Job/Providers/Utility）

#### WEB
静态页面模式，目前版本不使用MVC独立web部署，主要负责UI交互、体验，数据读写全部来自WPF的接口（js对象注入特性）
前端依赖jqery、bootstrap、template等各种前端组件，保持所有插件支持bootstrap风格即可。
（11月份的版本再考虑切换到独立部署）

#### 业务核心库（Business）
业务/服务(Business/Service)组成，不依赖外部model，输出统一为json
接口部分配上返回格式说明即可，也可认为是匿名对象

#### 程序核心库（Framework）
包括Database，Log，Mail，Msg，Queue，cache，Auth等各类平台级的功能，可按需启用，
DB多实例模式，支持sqllite、sql、mysql等

TODO：目前核心库需要规整合并

#### 其他说明
model各层个按需自己创建及使用，但不要相互引用，对接模式都已json为准。


## 工具基本功能
功能说明，重点表述功能原则，并非详细程序/UI设计，高保真只能指导大原则，交互细节需要靠个人与团队完善。
体验第一原则，一切如果自己都用的不爽的功能，都要优化，接受组里至少2人的意见。

### 一、数据检查功能（检查规则）

#### 1.检查异常数据
    升级前：
        1.1 非标准产品的责任人解析规则
        1.2 异常流程模版（缺少关键字段：业务对象、业务类型）、流程步骤定义（默认值）
            -已启用的流程模版中没有所属系统
            -已启用的流程模版中业务对象和业务类型不匹配
        1.3 异常流程实例
            -流程实例没有对应流程模板
        1.4 在途流程中状态为[重新发起]的流程        

    升级后：
        1.1 异常流程模版（缺少关键字段：业务对象、业务类型）、流程步骤定义（默认值）
            -已启用的流程模版中没有业务对象
            -已启用的流程模版中业务对象和业务类型不匹配
            -模板中已经废弃的责任人
            -流程模版中DomainXML存在异常（时间较长，会检查物理文件）
        1.2 异常流程实例
            -流程实例没有对应业务类型
            -流程实例没有对应流程模板
            -流程实例没有对应SiteName
            -流程实例业务类型为空
        1.3 流程代办等标签页的流程分类总数和列表数量不一致

    全部：
        1.1 表单修改业务数据链接扫描
        1.2 HTML表单自定义JS扫描

    体验与必须功能：
        1.1 上述检查结果需要有导出功能（展示页面），可以供开发、一线人员功能分析数据问题
        1.2 详情界面需要有更准确的表述，帮助快速了解、查询问题细节
        1.3 带有文件检测的事项会导致程序会有假死现象，扫描时间长，考虑分批处理，优化体验，另外扫描中的效果需要补充，最好能针对到事项的进度控制。

圣哥、少东    
    

#### 2.表单检查
    2.1 表单扫描规则（需要继续补充规则）: 
        1.检测业务对象存在，对应物理文件是否存在
        2.流程模版表单的BT_DomainXML中存在字段，但是在业务对象中不存在（305SP1之前的系统），导致无法发起
        2.流程模版表单的BT_DomainXML中存在重复的字段，导致无法发起
        3.html表单检测
          3.1 检测html是否存在js(配置项)
          3.2 检测html对应的节点属性是否存在重复
          3.3 检测html中节点对应的BT_DomainXML是否存在
          3.4 检测html中节点对应属性是否正确(配置项)
          3.5 检测单列模式中列是否在BT_DomainXML是否存在
          3.6 html表单JavaScript代码中使用到bt_domainxml字段的模板
          3.7 html表单中字段重复的
        4.定制表单检测：
          4.1 检测对应文件是否存在
          4.2 检测对应文件中是否存在必须包含js文件
          4.3 检测单列模式中列是否在BT_DomainXML是否存在 
        5.pageload函数中有脚本错误，脚本中存在使用html控件的，getelementbyid("XXid")，扫描表单中是否存在XXid这个控件，不存在就会出问题。
        6.移动表单显示名称是否包含input命名的      
        7.域重名：手机表单域重名，PC表单域重名，domainxml中的域重名
    2.2 修改业务数据链接（原来在步骤中配置，现在是在业务对象中设置，扫描出来告知一线）
    2.3 定制表单中出现老平台的用法（appForm），与新工作流写法不兼容。（清单持续累积）
    2.4 表单中包含自定义的JS（打印中带JS可能会导致打印异常）
    ……

静静

#### 3.文件检查
    3.1、老系统业务对象文件扫描（参考domainxml的扫描规则，郭飞工具中有实现）
    3.2、老ERP直接调用工作流页面、对象的场景（表、字段累积补充）（305前）
    3.3、老ERP桌面部件打开方式。（）
    3.4、webconfig文件自动处理。
    ……
圣哥

#### 4、IIS站点相关检查(技术方案待验证)
    4.1、upfiles的虚拟目录设置
    4.2、……
老刘


#### 5、其他检查
    5.1、SSO检查
    5.2、签章导航栏检查    
    5.3、更新结果检查，检查工作流站点的代码文件是否正确更新到ERP、采招站点。

#### 6、异常结果，程序修复
     6.1 所有检查项的数据结果，能够关联到具体问题，由程序修复

### 二、升级功能
- - - 

#### 1、数据库升级。
        1.1、251~305为源数据库，630为目标数据库，按需选择升级路径。630目标库只包含工作流相关数据对象，但需要在升级前同步代码库中的SQL。
        1.2、工具对比最新版工作流数据库，生成结构升级（表、字段及约束、视图、存储过程、函数）、数据升级（除了前面以外的所有部分）2部分升级语句，结构升级SQL支持重复执行。
        1.3、清单化输出所有数据库结构更新的清单，便于后续进一步分析升级过程。        
        1.4、需要有快速还原功能，升级过程包含表备份，最终是快照还原，还是脚本还原根据使用情况决定，体验第一原则。
        1.5、原库中的索引需要加入到待移植清单，供分析使用。        
        1.6、支持251~305全系列数据升级到最新，标准版本升级语句需要内置到程序中。
        
老刘、少东

#### 2、工作流程序升级
        2.1、251~305全系列，支持一键生成更新包，630的程序内置到工具中。        
        2.2、已升级的可以继续分析，生成增量更新包。        
        2.3、插件更新与代码更新分离（控制包大小，方便一线接收）
少东

#### 3、ERP、采招站点文件修改。
        3.1、根据不同ERP版本生成必须要修改的文件清单，帮助开发修改与检查。（规则按客户复盘总结的提炼）        
        3.2、内嵌对比工具，文件对比时自动调整文件编码，防止出现修改后中文乱码。 （穷举各类型文件的打开方式 aspx,js,html,htc,vb,c#等代码文件）       
        3.3、工具完成webconfig等配置文件的内容修改
圣哥

#### 4、流程定义中的默认值。
        4.1、需要根据客户的使用情况生成默认值批量修改语句。（默认值清单化，勾选生成对应脚本）

圣哥
#### 5、数据迁移功能。
        5.1、支持历史所有版本->630版本。（251前不考虑）
老刘、少东

